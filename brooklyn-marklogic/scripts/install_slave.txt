echo ==============================================================================
echo                INSTALLING MARKLOGIC SLAVE
echo ==============================================================================


echo Installing MarkLogic rpm
sudo yum -y --nogpgcheck install lsb gdb
mkdir -p ~/marklogic_install/
unzip -d ~ ~/marklogic_install.zip
curl -O -XPOST -d'email=${driver.websiteUsername}&pass=${driver.websitePassword}' -f -L https://developer.marklogic.com/download/binaries/6.0/${driver.downloadFilename} -o ${driver.downloadFilename}
sudo -E -n -S -- rpm -i ~/marklogic_install/${driver.downloadFilename}
echo Finished Installing the MarkLogic rpm

sudo -E -n -S -- sed -i 's/MARKLOGIC_EC2_HOST=1/MARKLOGIC_EC2_HOST=0/' /etc/sysconfig/MarkLogic

pushd .

echo Copying xqy files
sudo -E -n -S -- cp join-cluster.xqy \
                     qa-restart.xqy \
                     transfer-cluster-config.xqy \
                     /opt/MarkLogic/Admin

sudo -E -n -S -- mkdir /var/opt/xqy

sudo -E -n -S -- cp xqy/bookmark.xqy \
                    xqy/delete.xqy \
                    xqy/search-debug.xqy \
                    xqy/search.xqy \
                    xqy/update.xqy \
                    xqy/verify.xqy \
                    xqy/view.xqy \
                    /var/opt/xqy

sudo -E -n -S -- cp get_db_id.xqy \
                    stats.xqy \
                    http-server-status.xqy \
                    get-hosts.xqy \
                    attach_replica.xqy \
                    detach_replica.xqy \
                    create_markmail_forests.xqy \
                    create_forests.xqy \
                    create_forests_with_fastdir.xqy \
                    create_s3_forests.xqy \
                    create_s3_forests_with_fastdir.xqy \
                    create_s3_replica_forests.xqy \
                    create_s3_replica_forests_with_fastdir.xqy \
                    create_replica_forests.xqy \
                    create_replica_forests_with_fastdir.xqy \
                    create_markmail_appserver.xqy \
                    create_markmail_database.xqy \
                    attach_markmail_forests.xqy \
                    create_httpserver.xqy \
                    create_role.xqy \
                    rewrite-hostname.xqy \
                    rewrite-assignments.xqy \
                    transfer-cluster-config.xqy \
                    set_metering_on.xqy \
                    /opt/MarkLogic/Admin
echo Finished copying xqy files

export MARKLOGIC_AWS_ACCESS_KEY=${driver.awsAccessKey}
export MARKLOGIC_AWS_SECRET_KEY=${driver.awsSecretKey}
export MARKLOGIC_AUTO_SCALE_GROUP=${driver.cluster}
chmod +x ./reset_ml_on_startup
sudo -E -n -S -- ./reset_ml_on_startup

popd

echo Starting MarkLogic
sudo -E -n -S -- /etc/init.d/MarkLogic start
#we are going to wait till we can connect over http
#todo: we need a smarter way to wait till a service is available. The code below is not working. so currently doing a dumb sleep
#echo Waiting till MarkLogic is available over http
#curl --retry 60 --retry-delay 1 'http://localhost:8001'
sleep 30

echo Installing new license
curl  'http://localhost:8001/license-go.xqy?license-key=${driver.licenseKey}&licensee=${driver.licensee}&ok'
sleep 2
echo Finished installing new license

echo Accepting agreement
curl 'http://localhost:8001/agree-go.xqy?accepted-agreement=development'
sleep 2
echo Finished accepting agreement

echo initialize-go.xqy
curl 'http://localhost:8001/initialize-go.xqy'
sleep 2

echo Restarting MarkLogic
curl 'http://localhost:8001/qa-restart.xqy'
#todo: better mechanism needed to wait till service is available again
sleep 60
echo Finished restarting MarkLogic

echo Joining cluster
curl --digest -u ${driver.user}:${driver.password} 'http://localhost:8001/join-cluster.xqy?server=${driver.masterAddress}&joiner=${driver.hostname}&user=${driver.user}&pass=${driver.password}'
echo Finished joining cluster

echo Transferring Cluster Config
curl --digest -u ${driver.user}:${driver.password} \
   'http://${driver.masterAddress}:8001/transfer-cluster-config.xqy?server=${driver.masterAddress}&joiner=${driver.hostname}'
echo Finished transferring Cluster config

echo Restarting MarkLogic
curl --digest -u ${driver.user}:${driver.password} 'http://localhost:8001/qa-restart.xqy'
#todo: better mechanism needed to wait till service is available again
sleep 30
echo Finished restarting MarkLogic

# Node has now joined cluster, after this it  add its forests to the DB

echo Creating MarkMail forrest
curl --digest -u ${driver.user}:${driver.password} \
   'http://${driver.masterAddress}:8001/create_markmail_forests.xqy?datadir=/var/opt/mldata&fcount=4&host=${driver.hostname}&node=node${driver.nodeId}&cluster=${driver.cluster}'
echo Finished creating MarkMail forrest

echo Attaching MarkMail forrest
curl --digest -u ${driver.user}:${driver.password} \
   'http://${driver.masterAddress}:8001/attach_markmail_forests.xqy?fcount=${driver.fcount}&host=${driver.hostname}&node=node${driver.nodeId}&cluster=${driver.cluster}'
echo Finished Attaching MarkMail forrest

echo ==============================================================================
echo                FINISHED INSTALLING MARKLOGIC SLAVE
echo ==============================================================================